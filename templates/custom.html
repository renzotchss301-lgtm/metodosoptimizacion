<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Problema Personalizado - Solver PL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .constraint-row {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .coefficient-input {
            max-width: 100px;
        }
        .results-section {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">← Volver al Inicio</a>
            <span class="navbar-brand">Problema Personalizado</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Configuración del Problema</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadFromLocalStorage()">Cargar Ejemplo</button>
                    </div>
                    <div class="card-body">
                        <form id="problemForm">
                            <!-- Número de Variables -->
                            <div class="mb-3">
                                <label class="form-label">Número de Variables de Decisión</label>
                                <input type="number" class="form-control" id="varCount" min="1" max="10" value="2" required>
                            </div>

                            <!-- Tipo de Optimización -->
                            <div class="mb-3">
                                <label class="form-label">Tipo de Optimización</label>
                                <select class="form-select" id="objectiveType" required>
                                    <option value="maximize">Maximizar</option>
                                    <option value="minimize">Minimizar</option>
                                </select>
                            </div>

                            <!-- Coeficientes de la Función Objetivo -->
                            <div class="mb-3">
                                <label class="form-label">Coeficientes de la Función Objetivo</label>
                                <div id="objectiveCoeffsContainer">
                                    <div class="input-group mb-1">
                                        <span class="input-group-text">x₁</span>
                                        <input type="number" class="form-control coefficient-input" step="any" value="40" required>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text">x₂</span>
                                        <input type="number" class="form-control coefficient-input" step="any" value="50" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Restricciones -->
                            <div class="mb-3">
                                <label class="form-label">Restricciones</label>
                                <div id="constraintsContainer">
                                    <!-- Restricción 1 -->
                                    <div class="constraint-row">
                                        <div class="row g-2 align-items-center">
                                            <div class="col-auto">
                                                <small>Restricción 1:</small>
                                            </div>
                                            <div class="col">
                                                <input type="number" class="form-control coefficient-input" placeholder="x₁" step="any" value="2" required>
                                            </div>
                                            <div class="col">
                                                <input type="number" class="form-control coefficient-input" placeholder="x₂" step="any" value="3" required>
                                            </div>
                                            <div class="col-auto">
                                                <select class="form-select">
                                                    <option value="<=" selected>&lt;=</option>
                                                    <option value=">=">&gt;=</option>
                                                    <option value="==">=</option>
                                                </select>
                                            </div>
                                            <div class="col">
                                                <input type="number" class="form-control" placeholder="Valor" step="any" value="12" required>
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeConstraint(this)">×</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Restricción 2 -->
                                    <div class="constraint-row">
                                        <div class="row g-2 align-items-center">
                                            <div class="col-auto">
                                                <small>Restricción 2:</small>
                                            </div>
                                            <div class="col">
                                                <input type="number" class="form-control coefficient-input" placeholder="x₁" step="any" value="1" required>
                                            </div>
                                            <div class="col">
                                                <input type="number" class="form-control coefficient-input" placeholder="x₂" step="any" value="2" required>
                                            </div>
                                            <div class="col-auto">
                                                <select class="form-select">
                                                    <option value="<=" selected>&lt;=</option>
                                                    <option value=">=">&gt;=</option>
                                                    <option value="==">=</option>
                                                </select>
                                            </div>
                                            <div class="col">
                                                <input type="number" class="form-control" placeholder="Valor" step="any" value="8" required>
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeConstraint(this)">×</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addConstraint()">
                                    + Agregar Restricción
                                </button>
                            </div>

                            <button type="submit" class="btn btn-success w-100">Resolver Problema</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Resultados</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultsContainer">
                            <p class="text-muted">Los resultados aparecerán aquí después de resolver el problema...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Variables globales
    let varCount = 2;

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        loadFromLocalStorage();
        updateCoefficientInputs();
    });

    // Actualizar cuando cambia el número de variables
    document.getElementById('varCount').addEventListener('change', function() {
        varCount = parseInt(this.value);
        updateCoefficientInputs();
        updateConstraints();
    });

    // Actualizar inputs de coeficientes objetivo
    function updateCoefficientInputs() {
        const container = document.getElementById('objectiveCoeffsContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < varCount; i++) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group mb-1';
            inputGroup.innerHTML = `
                <span class="input-group-text">x${i+1}</span>
                <input type="number" class="form-control coefficient-input" step="any" value="${i === 0 ? 40 : 50}" required>
            `;
            container.appendChild(inputGroup);
        }
    }

    // Actualizar restricciones
    function updateConstraints() {
        const constraints = document.querySelectorAll('.constraint-row');
        
        constraints.forEach(constraint => {
            const inputsContainer = constraint.querySelector('.row');
            const existingInputs = inputsContainer.querySelectorAll('input[type="number"].coefficient-input');
            const operatorSelect = inputsContainer.querySelector('select');
            const rhsInput = inputsContainer.querySelector('input[type="number"]:not(.coefficient-input)');
            const deleteBtn = inputsContainer.querySelector('.btn-danger');
            
            // Eliminar inputs existentes (excepto el último que es RHS)
            existingInputs.forEach(input => input.remove());
            
            // Agregar nuevos inputs para coeficientes
            for (let i = 0; i < varCount; i++) {
                const col = document.createElement('div');
                col.className = 'col';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-control coefficient-input';
                input.placeholder = `x${i+1}`;
                input.step = 'any';
                input.required = true;
                input.value = i === 0 ? (constraints.length > 1 ? 1 : 2) : (constraints.length > 1 ? 2 : 3);
                
                col.appendChild(input);
                inputsContainer.insertBefore(col, operatorSelect.parentElement);
            }
        });
    }

    // Agregar restricción
    function addConstraint() {
        const container = document.getElementById('constraintsContainer');
        const constraintCount = container.children.length + 1;
        
        const constraintDiv = document.createElement('div');
        constraintDiv.className = 'constraint-row';
        
        let coefficientsHTML = '';
        for (let i = 0; i < varCount; i++) {
            coefficientsHTML += `
                <div class="col">
                    <input type="number" class="form-control coefficient-input" placeholder="x${i+1}" step="any" value="${i === 0 ? 1 : 2}" required>
                </div>
            `;
        }
        
        constraintDiv.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <small>Restricción ${constraintCount}:</small>
                </div>
                ${coefficientsHTML}
                <div class="col-auto">
                    <select class="form-select">
                        <option value="<=" selected>&lt;=</option>
                        <option value=">=">&gt;=</option>
                        <option value="==">=</option>
                    </select>
                </div>
                <div class="col">
                    <input type="number" class="form-control" placeholder="Valor" step="any" value="10" required>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeConstraint(this)">×</button>
                </div>
            </div>
        `;
        
        container.appendChild(constraintDiv);
    }

    // Eliminar restricción
    function removeConstraint(button) {
        if (document.querySelectorAll('.constraint-row').length > 1) {
            button.closest('.constraint-row').remove();
            // Renumerar restricciones
            document.querySelectorAll('.constraint-row').forEach((row, index) => {
                row.querySelector('small').textContent = `Restricción ${index + 1}:`;
            });
        } else {
            alert('Debe haber al menos una restricción');
        }
    }

    // Cargar desde localStorage (ejemplos)
    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('problemData');
        if (savedData) {
            const problemData = JSON.parse(savedData);
            
            document.getElementById('varCount').value = problemData.var_count;
            document.getElementById('objectiveType').value = problemData.objective_type;
            
            varCount = problemData.var_count;
            updateCoefficientInputs();
            
            // Coeficientes objetivo
            const objectiveInputs = document.querySelectorAll('#objectiveCoeffsContainer input');
            objectiveInputs.forEach((input, index) => {
                input.value = problemData.objective_coeffs[index];
            });
            
            // Restricciones
            const container = document.getElementById('constraintsContainer');
            container.innerHTML = '';
            
            problemData.constraints.forEach((constraint, index) => {
                const constraintDiv = document.createElement('div');
                constraintDiv.className = 'constraint-row';
                
                let coefficientsHTML = '';
                for (let i = 0; i < varCount; i++) {
                    coefficientsHTML += `
                        <div class="col">
                            <input type="number" class="form-control coefficient-input" placeholder="x${i+1}" step="any" value="${constraint.coefficients[i]}" required>
                        </div>
                    `;
                }
                
                constraintDiv.innerHTML = `
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <small>Restricción ${index + 1}:</small>
                        </div>
                        ${coefficientsHTML}
                        <div class="col-auto">
                            <select class="form-select">
                                <option value="<=" ${constraint.type === '<=' ? 'selected' : ''}>&lt;=</option>
                                <option value=">=" ${constraint.type === '>=' ? 'selected' : ''}>&gt;=</option>
                                <option value="==" ${constraint.type === '==' ? 'selected' : ''}>=</option>
                            </select>
                        </div>
                        <div class="col">
                            <input type="number" class="form-control" placeholder="Valor" step="any" value="${constraint.rhs}" required>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeConstraint(this)">×</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(constraintDiv);
            });
            
            localStorage.removeItem('problemData');
        }
    }

    // Enviar formulario
    document.getElementById('problemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await solveProblem();
    });

    // Resolver problema
    async function solveProblem() {
        const resultsContainer = document.getElementById('resultsContainer');
        
        try {
            resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Resolviendo problema...</p></div>';
            
            // Recopilar datos del formulario
            const varCount = parseInt(document.getElementById('varCount').value);
            const objectiveType = document.getElementById('objectiveType').value;
            
            // Coeficientes objetivo
            const objectiveCoeffs = [];
            const objectiveInputs = document.querySelectorAll('#objectiveCoeffsContainer input');
            objectiveInputs.forEach(input => {
                objectiveCoeffs.push(parseFloat(input.value));
            });
            
            // Restricciones
            const constraints = [];
            const constraintElements = document.querySelectorAll('.constraint-row');
            
            constraintElements.forEach(constraint => {
                const coefficients = [];
                const inputs = constraint.querySelectorAll('input.coefficient-input');
                inputs.forEach(input => {
                    coefficients.push(parseFloat(input.value));
                });
                
                const operator = constraint.querySelector('select').value;
                const rhs = parseFloat(constraint.querySelector('input:not(.coefficient-input)').value);
                
                constraints.push({
                    coefficients: coefficients,
                    type: operator,
                    rhs: rhs
                });
            });
            
            // Enviar solicitud
            const response = await fetch('/api/solve_custom', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    var_count: varCount,
                    objective_type: objectiveType,
                    objective_coeffs: objectiveCoeffs,
                    constraints: constraints
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Mostrar resultados
            displayResults(data);
            
        } catch (error) {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        }
    }

    // Mostrar resultados
    function displayResults(data) {
        const resultsContainer = document.getElementById('resultsContainer');
        
        let html = `
            <div class="alert alert-success">
                <h6>¡Problema Resuelto Exitosamente!</h6>
                <p><strong>Estado:</strong> ${data.status}</p>
                <p><strong>Valor Óptimo:</strong> ${data.objective_value.toFixed(4)}</p>
            </div>
            
            <div class="mb-4">
                <h6>Variables de Decisión Óptimas:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Valor Óptimo</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        for (const [varName, value] of Object.entries(data.variables)) {
            html += `
                <tr>
                    <td><strong>${varName}</strong></td>
                    <td>${value.toFixed(4)}</td>
                </tr>
            `;
        }
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mb-4">
                <h6>Uso de Recursos:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Restricción</th>
                                <th>Recurso Usado</th>
                                <th>Recurso Disponible</th>
                                <th>Holgura</th>
                                <th>Precio Sombra</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        for (const [constrName, constrData] of Object.entries(data.constraints)) {
            const usage = data.constraint_usage[constrName];
            html += `
                <tr>
                    <td>${constrName}</td>
                    <td>${usage.used.toFixed(4)}</td>
                    <td>${usage.available.toFixed(4)}</td>
                    <td>${constrData.slack.toFixed(4)}</td>
                    <td>${constrData.shadow_price.toFixed(4)}</td>
                </tr>
            `;
        }
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-info">
                <small>
                    <strong>Nota:</strong> El precio sombra indica cuánto mejoraría la función objetivo 
                    por cada unidad adicional del recurso.
                </small>
            </div>
        `;
        
        resultsContainer.innerHTML = html;
    }
    </script>
</body>
</html>